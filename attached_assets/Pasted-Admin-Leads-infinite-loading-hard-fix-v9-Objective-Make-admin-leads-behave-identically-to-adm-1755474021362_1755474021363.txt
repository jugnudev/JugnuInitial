Admin/Leads “infinite loading” hard fix (v9)

Objective
Make /admin/leads behave identically to /admin/promote: same provider, same login, same storage key, same header. Stop any network calls until auth is confirmed. Add a visible debug banner. Remove lazy-load flakiness. Prove success with an echo test.

1) Router: ensure the provider actually wraps /admin/*

Create/verify src/routes/AdminShell.tsx:

import { Outlet } from 'react-router-dom';
import { AdminAuthProvider } from '@/lib/AdminAuthProvider';

export default function AdminShell() {
  return (
    <AdminAuthProvider>
      <Outlet />
    </AdminAuthProvider>
  );
}


In your router config, wrap all admin routes with AdminShell. Example:

{
  path: '/admin',
  element: <AdminShell />,   // <-- provider here
  children: [
    { path: 'promote', element: <AdminPromote /> },
    { path: 'leads',   element: <AdminLeads /> }, // no lazy for now
  ]
}


IMPORTANT: Temporarily remove React.lazy for AdminLeads (eager import) to avoid chunk/suspense edge cases causing a perma-spinner.

2) Use the EXACT same login component & auth state as /admin/promote

Extract the same login component used by /admin/promote to src/components/admin/AdminLogin.tsx and use it on /admin/leads.

Both pages must use the same localStorage key: jugnu-admin-dev-2025 and send it as header x-admin-key on every admin request (already set up via your shared fetchAdmin hook).

After a successful login, call the context login(key) then navigate/refresh the same route so queries become enabled.

3) Gate every fetch with isAuthed (no pre-auth calls, no 401 loops)

In AdminLeads and any subcomponents, replace fetches with the shared admin fetch hook and gate queries:

const { isAuthed, logout } = useAdminAuth();
const adminFetch = useAdminFetch();

const q = useQuery({
  queryKey: ['admin-leads', filters],
  queryFn: async () => {
    const r = await adminFetch('/api/admin/leads?'+new URLSearchParams(filters));
    if (r.status === 401 || r.status === 403) throw new Error('UNAUTH');
    return r.json();
  },
  enabled: isAuthed,   // <-- do not run until logged in
  retry: false,        // <-- no spinner loops on auth errors
  refetchOnWindowFocus: false,
});

if (!isAuthed) return <AdminLogin />;
if (q.isError && (q.error as Error).message === 'UNAUTH') { logout(); return <AdminLogin />; }

4) Add a visible debug banner (only with ?debug=1)

At the top of AdminLeads render:

function AdminDebugBanner() {
  const { key, isAuthed } = useAdminAuth();
  const adminFetch = useAdminFetch();
  if (new URLSearchParams(location.search).get('debug') !== '1') return null;
  const test = async () => {
    const r = await adminFetch('/api/admin/echo-auth');
    console.log('echo-auth', r.status, await r.text());
  };
  return (
    <div className="p-2 text-xs bg-amber-900/40 rounded mb-2">
      <div>isAuthed: {String(isAuthed)} | keyLen: {key.length}</div>
      <button onClick={test} className="underline">Test echo-auth</button>
    </div>
  );
}


Show <AdminDebugBanner /> above the table. Remove later if you want.

5) Backend: verify middleware on ALL admin leads routes

Confirm /api/admin/leads* and CSV routes use the same requireAdminKey middleware as /api/admin/promote*.

Keep the echo endpoint:

app.get('/api/admin/echo-auth', requireAdminKey, (req,res)=>res.json({ ok:true }));

6) Kill any leftover conflicting code

Delete any session/cookie logic under admin/leads (frontend + server).

Remove credentials: 'include' from admin/leads fetches.

Ensure every admin/leads request uses the shared useAdminFetch() (which injects x-admin-key).

7) Acceptance tests (please run)

Visit /admin/promote, log in with jugnu1401.

Open /admin/leads?debug=1 in the same tab:

You should not see the login; the table should load.

Debug banner: isAuthed: true, keyLen > 0.

Click “Test echo-auth” → console shows 200 {"ok":true...}.

Network shows x-admin-key: jugnu1401 on every /api/admin/leads* request.

Clear localStorage['jugnu-admin-dev-2025'] and refresh /admin/leads: you should see the login (not a spinner).

Log in on /admin/leads directly → table appears within ~1s.