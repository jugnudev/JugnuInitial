1) Fix /api/health (trivial)

Prompt to agent:

Implement GET /api/health that always returns JSON { ok: true } with Content-Type: application/json. Add a tiny in-process cache header and include the app version if available, e.g. { ok:true, version: APP_VERSION || 'dev' }. Ensure 200 status and that all /api/* routes never fall back to HTML.

2) Metrics schema: add missing columns & reload PostgREST

You already added a robust migration for tokens. Tell the agent to keep that as source of truth and only add what’s missing for metrics.

Prompt to agent:

Do an idempotent migration for public.sponsor_metrics_daily to ensure these columns exist with defaults:

"date" date

raw_views int not null default 0

billable_impressions int not null default 0

clicks int not null default 0

unique_users int not null default 0
Also ensure a unique index on (campaign_id, placement, "date"). After the migration, call select pg_notify('pgrst','reload schema');. Use the service-role client or my Supabase SQL runner; do not drop anything.

After migrating, re-run the self-test Tracking section and paste the JSON.

(If you want the exact SQL again, here it is—idempotent):

alter table public.sponsor_metrics_daily
  add column if not exists "date" date,
  add column if not exists raw_views int not null default 0,
  add column if not exists billable_impressions int not null default 0,
  add column if not exists clicks int not null default 0,
  add column if not exists unique_users int not null default 0;

create unique index if not exists sponsor_metrics_daily_unique_idx
  on public.sponsor_metrics_daily (campaign_id, placement, "date");

select pg_notify('pgrst','reload schema');

3) Fix self-test “Portal Tokens” (UUID vs hex)

Prompt to agent:

Update /api/admin/selftest so the Portal Tokens test uses the UUID tokenId returned by /api/admin/portal-tokens when calling /api/spotlight/portal/:tokenId. Do not attempt to cast hex tokens to UUID. If we still accept legacy hex tokens, do it by detecting non-UUID params and querying by token (text) instead of id—without casting. Re-run the self-test and paste the new results.

4) Implement CSV export for the portal

Prompt to agent:

Add GET /api/spotlight/portal/:tokenId/export.csv that:

Authenticates by token (UUID id or legacy token), resolves the campaign + date range.

Returns text/csv with headers: date,placement,billable_impressions,raw_views,clicks,unique_users,ctr.

Includes at least the last 30 days (or campaign range), ordered by date.

No HTML, always a CSV body or a JSON error.
Wire the “Export CSV” button on /sponsor/:tokenId to this endpoint. Show a toast on failure.

5) Seed real metrics & verify the portal

Prompt to agent:

Create a short test campaign (or reuse CID 6c996eab-f5c5-42ae-b206-555975757b6b if present), then:

Visit /events?debugSponsor=1, scroll the banner ≥50% (impression), click once (redirect).

If present, also call GET /api/spotlight/admin/metrics/test?campaignId=<CID> (admin key) to ensure ≥2 rows written.

Call GET /api/spotlight/portal/<TID> and show non-zero totals and at least one daily point for today.

Download /api/spotlight/portal/<TID>/export.csv and paste the first 3 lines.

Re-run /api/admin/selftest and paste the JSON.

Acceptance (for this step):

billable_impressions ≥ 1, clicks ≥ 1

trend charts render today’s point

CSV endpoint returns 200 with today’s row

6) Confirm the schema we already applied (so the agent doesn’t fight it)

Prompt to agent:

Treat the following as the source of truth for public.sponsor_portal_tokens. Do not attempt to rename/drop columns. All new code/tests must honor this shape:

id uuid primary key default gen_random_uuid() (PK)

campaign_id uuid not null

token text (legacy hex, unique where not null)

is_active boolean not null default true

created_at timestamptz not null default now()

expires_at timestamptz not null default now()+interval '30 days'

index on (campaign_id)
We already created a partial unique index on token and ensured PK on id. Keep portal endpoints accepting both UUID id and legacy token parameters with no casts.

7) (Optional) Make /api/health reflect DB state

Prompt to agent:

Enhance /api/health to include { ok:true, db:true, tables:{ sponsor_metrics_daily:true, sponsor_portal_tokens:true }, time: <iso> }. Fail with { ok:false } if the DB call fails. Keep JSON only.

8) Quick curl pack you (or the agent) can use after fixes
# Set BASE once (public URL, not localhost on Replit)
export BASE="https://<your-replit>.replit.dev"
export KEY="$EXPORT_ADMIN_KEY"

# Health
curl -s "$BASE/api/health"

# Create campaign (if needed)
curl -s -X POST "$BASE/api/admin/campaigns" \
  -H "x-admin-key: $KEY" -H "Content-Type: application/json" \
  -d '{"campaignName":"Portal E2E","sponsorName":"Portal QA","headline":"QA","subline":"E2E","clickUrl":"https://example.com","placements":["events_banner"],"priority":0,"isActive":true,"showSponsored":true,"frequencyCapPerUserPerDay":0,"startDate":"'"$(date +%F)"'","endDate":"'"$(date -d '+2 day' +%F)"'"}'

# Token
CID="<paste-campaign-id>"
curl -s -X POST "$BASE/api/admin/portal-tokens" \
  -H "x-admin-key: $KEY" -H "Content-Type: application/json" \
  -d '{"campaignId":"'$CID'","expiresInHours":72}'

# After you capture TID:
TID="<paste-token-id>"
curl -s "$BASE/api/spotlight/portal/$TID"
curl -s "$BASE/api/spotlight/portal/$TID/export.csv" | head -n 5

# Self-test
curl -s "$BASE/api/admin/selftest" -H "x-admin-key: $KEY"


Note: the earlier curl error “URL rejected: No host part in the URL” happened because $BASE wasn’t set. Always export BASE="https://…" first on Replit.