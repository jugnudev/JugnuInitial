Context — DDL I already ran in Supabase

-- Enable uuid generator
create extension if not exists pgcrypto;

-- sponsor_portal_tokens
do $$
begin
  if not exists (
    select 1 from information_schema.columns
    where table_schema='public' and table_name='sponsor_portal_tokens' and column_name='id'
  ) then
    alter table public.sponsor_portal_tokens add column id uuid;
  end if;
end$$;

update public.sponsor_portal_tokens
set id = gen_random_uuid()
where id is null;

alter table public.sponsor_portal_tokens
  alter column id set not null,
  alter column id set default gen_random_uuid();

alter table public.sponsor_portal_tokens
  add column if not exists token text;

create unique index if not exists sponsor_portal_tokens_token_uniq
  on public.sponsor_portal_tokens (token)
  where token is not null;

alter table public.sponsor_portal_tokens
  add column if not exists is_active boolean not null default true,
  add column if not exists created_at timestamptz not null default now(),
  add column if not exists expires_at timestamptz not null default now() + interval '30 days';

create index if not exists sponsor_portal_tokens_campaign_idx
  on public.sponsor_portal_tokens (campaign_id);

do $$
declare
  pk_name text;
  pk_col  text;
begin
  select tc.constraint_name, kcu.column_name
  into pk_name, pk_col
  from information_schema.table_constraints tc
  join information_schema.key_column_usage kcu
    on kcu.constraint_name = tc.constraint_name
   and kcu.table_schema   = tc.table_schema
   and kcu.table_name     = tc.table_name
  where tc.table_schema='public'
    and tc.table_name='sponsor_portal_tokens'
    and tc.constraint_type='PRIMARY KEY'
  limit 1;

  if pk_col is distinct from 'id' then
    execute format('alter table public.sponsor_portal_tokens drop constraint %I', pk_name);
    alter table public.sponsor_portal_tokens add primary key (id);
  end if;
end$$;

-- sponsor_metrics_daily
alter table public.sponsor_metrics_daily
  add column if not exists "date" date;

create unique index if not exists sponsor_metrics_daily_unique_idx
  on public.sponsor_metrics_daily (campaign_id, placement, "date");

select pg_notify('pgrst','reload schema');


Please do the following:

Regenerate Supabase types / update server & client code to use sponsor_portal_tokens.id (uuid) as the primary key. Keep token (text) only as a legacy optional column; never cast it to uuid.

Self-test & portal lookups:

If response has {tokenId: "<uuid>"}, use that directly.

If you ever handle a legacy {token: "<64-hex>"}, query by token as text (no uuid casts).

Fix the self-test “Portal Tokens” step to branch on isUuid() and avoid any uuid casting of hex.

Create-token endpoint: DB generates UUID (id) only. Return { ok:true, tokenId:"<uuid>", expiresAt:"..." }. Do not accept a client-provided token.

Onboarding email: Add a “Recipient email” field in the admin dialog and post { tokenId, recipient } (or { token, recipient } for legacy). Validate and audit-log the recipient. Show a success toast that includes the address.

Metrics schema — missing columns: The self-test still fails looking for raw_views. Please add/confirm these columns on public.sponsor_metrics_daily and refresh the PostgREST schema cache:

alter table public.sponsor_metrics_daily
  add column if not exists raw_views int not null default 0,
  add column if not exists billable_impressions int not null default 0,
  add column if not exists clicks int not null default 0,
  add column if not exists unique_users int not null default 0;
select pg_notify('pgrst','reload schema');


Then update the admin self-test to insert two rows for today using the service-role client and assert metricsRecorded >= 2.

Add a dev-only /api/admin/reload-schema (x-admin-key) that calls select pg_notify('pgrst','reload schema'); so future DDL is immediately visible, and have the self-test call it before verifying columns.

Confirm dev portal host gating is permissive for localhost, 127.0.0.1, and *.replit.dev and paste the actual condition you’re using.

Re-run the Admin Self-test and paste the “Tracking” and “Portal Tokens” sections (should be PASS).

Also: please remove any now-redundant migrations to avoid future “multiple primary keys” errors, and ensure all admin alias routes still return JSON and use the service-role where appropriate.