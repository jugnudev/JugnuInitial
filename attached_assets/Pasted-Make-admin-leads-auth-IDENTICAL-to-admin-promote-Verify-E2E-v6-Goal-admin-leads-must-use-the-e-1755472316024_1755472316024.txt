Make admin/leads auth IDENTICAL to admin/promote + Verify E2E (v6)

Goal
/admin/leads must use the exact same authentication mechanism, UI, storage key, headers, and middleware as /admin/promote, so if I log in once, both pages work. Also confirm date pickers + creative uploads + DB writes still work after the change.

1) Unify auth (frontend)

Create a shared auth util used by both pages:

src/lib/adminAuth.ts

export const ADMIN_LOCAL_KEY = 'jugnu-admin-dev-2025'; // must be the SAME one admin/promote uses
export function getAdminKey(){ return localStorage.getItem(ADMIN_LOCAL_KEY) || ''; }
export function setAdminKey(v:string){ localStorage.setItem(ADMIN_LOCAL_KEY, v); }
export function clearAdminKey(){ localStorage.removeItem(ADMIN_LOCAL_KEY); }


Create a shared fetch wrapper:

src/lib/fetchAdmin.ts

import { getAdminKey } from './adminAuth';
export async function fetchAdmin(input: RequestInfo, init: RequestInit = {}) {
  const key = getAdminKey();
  const headers = new Headers(init.headers || {});
  if (key) headers.set('x-admin-key', key);
  return fetch(input, { ...init, headers });
}


Replace all admin/leads fetches to use fetchAdmin.

Ensure the login UI component for /admin/leads is literally the same component used by /admin/promote (same styling, same logic). If admin/promote uses a single POST to /api/admin/login:

On success, store returned adminKey via setAdminKey(adminKey).

If admin/promote does not call /api/admin/login and simply stores the password as the key, mirror that behavior exactly. Do not invent a different flow.

2) Unify auth (backend)

Create a single middleware used by both promote and leads admin APIs:

server/middleware/requireAdminKey.ts

export function requireAdminKey(req,res,next){
  const key = req.header('x-admin-key') || '';
  if (!key) return res.status(401).json({ ok:false, error:'Missing admin key' });
  if (key !== process.env.ADMIN_PASSWORD) return res.status(403).json({ ok:false, error:'Invalid admin key' });
  return next();
}


Apply this middleware to:

/api/admin/leads*

/api/admin/promote*

and any internal leads endpoints used by the Admin UI (list, read, update, CSV).

Ensure CORS is not interfering (both pages are same origin, so default is fine).

Keep the existing /api/admin/login behavior exactly as admin/promote expects. If it just validates the password and echoes back the key, keep it unchanged.

3) Remove conflicting auth code

Delete any session/cookie-based auth branches from admin/leads (frontend and server) that differ from promote.

Delete any credentials:'include' fetches under admin/leads—use fetchAdmin only.

Ensure there’s one source of truth for ADMIN password: process.env.ADMIN_PASSWORD (already jugnu1401).

4) UX polish & correctness already requested

Full Feature checkout preview:

Remove “weekly saves …” ribbon (weekly-only package).

Add-ons greyed out with message “Included in this package” only if you decided Full Feature includes them by default.

If Full Feature does NOT include IG Story/Email by default, then do not grey them out; leave them as priced add-ons. Mirror your latest intended behavior.

Application Form

Desired dates = Start date + End date pickers (required).

Dynamic creative requirements:

Full Feature → 4 upload fields (Events desktop/mobile + Home desktop/mobile) with the exact size hints we defined.

Single-placement packages → 2 fields with correct size hints.

Drag-and-drop continues to work via the file inputs.

5) Diagnostics & logging

Add server logs for admin routes:

Log when x-admin-key is missing or invalid including the route.

Add /api/admin/echo-auth (protected) that returns { ok:true } so we can test the header quickly.

In the browser Network tab, confirm all admin/leads requests carry the x-admin-key header after login.

6) Tests / QA (must run these)

Auth parity

Go to /admin/promote, log in with jugnu1401.

Navigate to /admin/leads without re-logging. It should load the table.

Clear localStorage key → both pages should prompt for login again.

Leads UI

List loads quickly (<500ms after network fetch), filters work, CSV export downloads.

Quote → Application

Create a quote for Events (daily) + IG Story; continue to application; submit; DB row shows correct fields.

Create a quote for Full Feature (weekly) + Email Feature; submit with 4 assets; DB row shows ack_guarantee=true, 4 URLs saved.

Error handling

With no admin key: /api/admin/leads returns { ok:false, error:'Missing admin key' }.

With wrong key: { ok:false, error:'Invalid admin key' }.

7) Acceptance Criteria

Logging into either /admin/promote or /admin/leads unlocks both.

The same localStorage key (jugnu-admin-dev-2025) and the same x-admin-key header are used by both pages.

No spinning/loading loops; invalid password shows an inline error immediately.

All admin/leads APIs return data when logged in; CSV export works.

Checkout preview + application form still work, with dynamic creative fields and required date pickers.

All DB writes (quotes, leads, assets) succeed; no schema errors.

If anything in admin/promote differs from this spec, mirror whatever admin/promote actually does, don’t “improve” it. The point is parity, not a new auth scheme.